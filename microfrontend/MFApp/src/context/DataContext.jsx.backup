import React, { createContext, useContext, useState, useEffect } from 'react';

const DataContext = createContext();

export const DataProvider = ({ children }) => {
    const [projects, setProjects] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Fetch projects from API
    const fetchProjects = async () => {
        try {
            setLoading(true);
            // Replace with your actual API endpoint
            const response = await fetch('https://api.example.com/projects');
            if (!response.ok) throw new Error('Failed to fetch projects');
            const data = await response.json();
            setProjects(data);
            setError(null);
        } catch (err) {
            console.error('Error fetching projects:', err);
            setError(err.message);
            // Fallback to mock data in case of error
            loadMockData();
        } finally {
            setLoading(false);
        }
    };

    // Mock data loader (for development)
    const loadMockData = () => {
        const mockProjects = [
            {
                id: 1,
                name: 'Component Library',
                description: 'Building reusable UI components',
                status: 'active',
                totalTasks: 15,
                completedTasks: 12,
                tasks: [
                    { id: 1, title: 'Create Button Component', status: 'done', projectId: 1 },
                    { id: 2, title: 'Create Input Component', status: 'done', projectId: 1 },
                    { id: 3, title: 'Add TypeScript support', status: 'in-progress', projectId: 1 },
                    { id: 4, title: 'Write documentation', status: 'todo', projectId: 1 },
                ]
            },
            {
                id: 2,
                name: 'API Integration',
                description: 'Connecting backend services',
                status: 'active',
                totalTasks: 10,
                completedTasks: 5,
                tasks: [
                    { id: 5, title: 'Setup authentication', status: 'done', projectId: 2 },
                    { id: 6, title: 'Create API client', status: 'in-progress', projectId: 2 },
                    { id: 7, title: 'Error handling', status: 'todo', projectId: 2 },
                ]
            },
            {
                id: 3,
                name: 'Testing Suite',
                description: 'Comprehensive test coverage',
                status: 'active',
                totalTasks: 8,
                completedTasks: 3,
                tasks: [
                    { id: 8, title: 'Unit tests for components', status: 'in-progress', projectId: 3 },
                    { id: 9, title: 'Integration tests', status: 'todo', projectId: 3 },
                ]
            },
            {
                id: 4,
                name: 'Documentation',
                description: 'User and developer guides',
                status: 'completed',
                totalTasks: 5,
                completedTasks: 5,
                tasks: [
                    { id: 10, title: 'API documentation', status: 'done', projectId: 4 },
                    { id: 11, title: 'User guide', status: 'done', projectId: 4 },
                ]
            }
        ];
        setProjects(mockProjects);
    };

    // CRUD operations for projects
    const addProject = async (projectData) => {
        try {
            const response = await fetch('https://api.example.com/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectData)
            });
            if (!response.ok) throw new Error('Failed to create project');
            const newProject = await response.json();
            setProjects([...projects, newProject]);
            return newProject;
        } catch (err) {
            console.error('Error creating project:', err);
            // Fallback: add to local state
            const newProject = {
                ...projectData,
                id: Date.now(),
                tasks: []
            };
            setProjects([...projects, newProject]);
            return newProject;
        }
    };

    const updateProject = async (projectId, updates) => {
        try {
            const response = await fetch(`https://api.example.com/projects/${projectId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            if (!response.ok) throw new Error('Failed to update project');
            const updatedProject = await response.json();
            setProjects(projects.map(p => p.id === projectId ? updatedProject : p));
            return updatedProject;
        } catch (err) {
            console.error('Error updating project:', err);
            // Fallback: update local state
            setProjects(projects.map(p =>
                p.id === projectId ? { ...p, ...updates } : p
            ));
        }
    };

    const deleteProject = async (projectId) => {
        try {
            const response = await fetch(`https://api.example.com/projects/${projectId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to delete project');
            setProjects(projects.filter(p => p.id !== projectId));
        } catch (err) {
            console.error('Error deleting project:', err);
            // Fallback: delete from local state
            setProjects(projects.filter(p => p.id !== projectId));
        }
    };

    // CRUD operations for tasks
    const addTask = async (projectId, taskData) => {
        try {
            const response = await fetch(`https://api.example.com/projects/${projectId}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });
            if (!response.ok) throw new Error('Failed to create task');
            const newTask = await response.json();

            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    return {
                        ...p,
                        tasks: [...(p.tasks || []), newTask],
                        totalTasks: p.totalTasks + 1
                    };
                }
                return p;
            }));
            return newTask;
        } catch (err) {
            console.error('Error creating task:', err);
            // Fallback: add to local state
            const newTask = {
                ...taskData,
                id: Date.now(),
                projectId
            };
            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    return {
                        ...p,
                        tasks: [...(p.tasks || []), newTask],
                        totalTasks: p.totalTasks + 1
                    };
                }
                return p;
            }));
            return newTask;
        }
    };

    const updateTask = async (projectId, taskId, updates) => {
        try {
            const response = await fetch(`https://api.example.com/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            if (!response.ok) throw new Error('Failed to update task');
            const updatedTask = await response.json();

            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    const updatedTasks = p.tasks.map(t => t.id === taskId ? updatedTask : t);
                    const completedCount = updatedTasks.filter(t => t.status === 'done').length;
                    return {
                        ...p,
                        tasks: updatedTasks,
                        completedTasks: completedCount
                    };
                }
                return p;
            }));
            return updatedTask;
        } catch (err) {
            console.error('Error updating task:', err);
            // Fallback: update local state
            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    const updatedTasks = p.tasks.map(t =>
                        t.id === taskId ? { ...t, ...updates } : t
                    );
                    const completedCount = updatedTasks.filter(t => t.status === 'done').length;
                    return {
                        ...p,
                        tasks: updatedTasks,
                        completedTasks: completedCount
                    };
                }
                return p;
            }));
        }
    };

    const deleteTask = async (projectId, taskId) => {
        try {
            const response = await fetch(`https://api.example.com/tasks/${taskId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to delete task');

            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    const updatedTasks = p.tasks.filter(t => t.id !== taskId);
                    const completedCount = updatedTasks.filter(t => t.status === 'done').length;
                    return {
                        ...p,
                        tasks: updatedTasks,
                        totalTasks: p.totalTasks - 1,
                        completedTasks: completedCount
                    };
                }
                return p;
            }));
        } catch (err) {
            console.error('Error deleting task:', err);
            // Fallback: delete from local state
            setProjects(projects.map(p => {
                if (p.id === projectId) {
                    const updatedTasks = p.tasks.filter(t => t.id !== taskId);
                    const completedCount = updatedTasks.filter(t => t.status === 'done').length;
                    return {
                        ...p,
                        tasks: updatedTasks,
                        totalTasks: p.totalTasks - 1,
                        completedTasks: completedCount
                    };
                }
                return p;
            }));
        }
    };

    // Calculated stats
    const stats = {
        totalProjects: projects.length,
        activeProjects: projects.filter(p => p.status === 'active').length,
        totalTasks: projects.reduce((sum, p) => sum + (p.totalTasks || 0), 0),
        completedTasks: projects.reduce((sum, p) => sum + (p.completedTasks || 0), 0),
        progressPercentage: function() {
            if (this.totalTasks === 0) return 0;
            return Math.round((this.completedTasks / this.totalTasks) * 100);
        }
    };

    // Load data on mount
    useEffect(() => {
        // For development, use mock data
        // In production, call fetchProjects()
        loadMockData();
        setLoading(false);

        // Uncomment for real API:
        // fetchProjects();
    }, []);

    const value = {
        projects,
        loading,
        error,
        stats,
        // CRUD operations
        addProject,
        updateProject,
        deleteProject,
        addTask,
        updateTask,
        deleteTask,
        // Utility
        refreshProjects: fetchProjects
    };

    return <DataContext.Provider value={value}>{children}</DataContext.Provider>;
};

export const useData = () => {
    const context = useContext(DataContext);
    if (!context) {
        throw new Error('useData must be used within a DataProvider');
    }
    return context;
};
